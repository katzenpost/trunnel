# trunnel

Code generator for binary parsing. Golang port of the [original implementation
for the Tor project](https://gitweb.torproject.org/trunnel.git).

[![go.dev Reference](https://img.shields.io/badge/doc-reference-007d9b?logo=go&style=flat-square)](https://pkg.go.dev/github.com/mmcloughlin/trunnel)
[![Build status](https://img.shields.io/travis/mmcloughlin/trunnel.svg?style=flat-square)](https://travis-ci.org/mmcloughlin/trunnel)
[![Coverage](https://img.shields.io/coveralls/mmcloughlin/trunnel.svg?style=flat-square)](https://coveralls.io/r/mmcloughlin/trunnel)
[![Go Report Card](https://goreportcard.com/badge/github.com/mmcloughlin/trunnel?style=flat-square)](https://goreportcard.com/report/github.com/mmcloughlin/trunnel)

## Description

Writing parsers for binary formats is error-prone and tedious. Critical security
vulnerabilities are frequently found in parser code, especially in low-level
languages such as C. Trunnel is a [domain-specific
language](https://en.wikipedia.org/wiki/Domain-specific_language) for describing
binary formats and a parser generator for those formats.

Trunnel was [initially
designed](https://lists.torproject.org/pipermail/tor-dev/2014-August/007355.html)
and [implemented](https://gitweb.torproject.org/trunnel.git) by Nick Mathewson
for the [Tor Project](https://www.torproject.org/). This Golang port is intended
to support efforts to implement a [Tor Relay in
Go](https://github.com/mmcloughlin/pearl), with the goal of sharing trunnel
files with the core Tor codebase.

## Quick Start

Install `trunnel` with

```
go get -u github.com/mmcloughlin/trunnel/cmd/trunnel
```

As a very simple example, we can define a color struct in trunnel as follows.

[embedmd]:# (examples/color/color.trunnel c)
```c
struct color {
  u8 r;
  u8 g;
  u8 b;
};
```

Compile this with the `trunnel` tool as follows.

```
trunnel build -p color color.trunnel
```

The result will be a Golang package called `color` with a `Color` type and
methods to marshal to and from binary representation.

[embedmd]:# (examples/color/gen-marshallers.go)
```go
// Code generated by trunnel. DO NOT EDIT.

package color

import "errors"

type Color struct {
	R uint8
	G uint8
	B uint8
}

func (c *Color) Parse(data []byte) ([]byte, error) {
	cur := data
	{
		if len(cur) < 1 {
			return nil, errors.New("data too short")
		}
		c.R = cur[0]
		cur = cur[1:]
	}
	{
		if len(cur) < 1 {
			return nil, errors.New("data too short")
		}
		c.G = cur[0]
		cur = cur[1:]
	}
	{
		if len(cur) < 1 {
			return nil, errors.New("data too short")
		}
		c.B = cur[0]
		cur = cur[1:]
	}
	return cur, nil
}

func ParseColor(data []byte) (*Color, error) {
	c := new(Color)
	_, err := c.Parse(data)
	if err != nil {
		return nil, err
	}
	return c, nil
}
```

## Features

Integer fields may have constraints.

[embedmd]:# (examples/date/date.trunnel c)
```c
struct date {
   u16 year IN [ 1970..65535 ];
   u8 month IN [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 ];
   u8 day IN [ 1,2,3..31 ];
};
```

Please consult the [trunnel manual](http://mmcloughlin.com/trunnel/manual.html)
for the full feature set.
